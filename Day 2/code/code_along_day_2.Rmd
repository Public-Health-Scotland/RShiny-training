---
title: "Code along day 2"
author: "Julia Moeller"
date: "2023-09-06"
output: 
  html_document:
    toc: true
    toc_depth: 2
    toc_float: true
    toc_collapsed: true

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

The following markdown has the correct code for the Code along section of Shiny training day 2.

# Empty app

## Global
```{r, eval = FALSE}
library(dplyr) #data manipulation
library(plotly) #charts
library(ggplot2)
library(shiny)
library(shinyWidgets)
library(tidyr)
library(magrittr)
library(readr)

# LOAD DATA ----

data_allergy <- readRDS("data/allergy_scotland_chart_PRA.rds")

data_asthma <- readRDS("data/asthma_final.rds") %>%
  mutate(rate = round(rate, 1))

# CREATE OBJECTS USED IN OUTPUTS ----

condition_list <- sort(unique(data_allergy$type)) # allergies
diagnosis_list <- sort(unique(data_asthma$diagnosis)) # asthma
data_list_data_tab <- c("Allergies Data" = "data_allergy", 
                        "Asthma Data" = "data_asthma")
```

## UI

```{r, eval = FALSE}
 navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            

# ALLERGIC CONDITIONS TAB ----
             

# ASTHMA TAB ----


# DATA DOWNLOADS TAB ----
             

 ) #END OF FLUIDPAGE (USER INTERFACE)
```

## Server

```{r, eval = FALSE}

function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  #output$chart <- renderPlotly({ 
  #  
  #  #Data for condition
  #  data_condition <- data_allergy %>% subset(type %in% input$conditions & measure==input$measure)
  #  
  #  #y axis title
  #  yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
  #                          input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
  #  
  #  plot <- 
  #    ggplot(data_condition, aes(x = year, y = value, colour = type)) +
  #    geom_line(aes(group=1)) +
  #    theme_minimal()
  #  
  #  ggplotly(height = 500,
  #           width = 1000) %>%
  #    layout(annotations = list(), #It needs this because of a buggy behaviour
  #           yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
  #           xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
  #           font = list(family = 'Arial, sans-serif'), # font
  #           margin = list(pad = 4, t = 50, r = 30), # margin-paddings
  #           hovermode = 'false') %>% # to get hover compare mode as default
  #    config(displayModeBar= T, displaylogo = F)
  #  #Layout
  #  # taking out plotly logo and collaborate button
  #}
  #)

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  #plot_charts <- function(sex_chosen, age_grp_chosen) { 
  #  
  #  data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
  #                                        sex == sex_chosen &
  #                                        age_grp == age_grp_chosen)
  #  
  #  #y axis title
  #  yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
  #                          input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
  #  
  #  plot <- 
  #    ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
  #    geom_line(aes(group=1)) +
  #    theme_minimal()
  #  
  #  ggplotly() %>%
  #    layout(annotations = list(),
  #           yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
  #           xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
  #           font = list(family = 'Arial, sans-serif'), 
  #           margin = list(pad = 4, t = 50, r = 30), 
  #           hovermode = 'false') %>% 
  #    config(displayModeBar= T, displaylogo = F) 
  #  
  #}
  #
  ## Here, the plot_charts function created above is put into use
  #output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% layout(title = "Males All Ages")}) 
  #output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% layout(title = "Females All Ages")}) 
  #output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% layout(title = "Males Under 10")})
  #output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% layout(title = "Females Under 10")}) 
  #output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% layout(title = "Males Over 10")}) 
  #output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% layout(title = "Females Over 10")})
  


# CREATE THE DATA TABLE ----


# RENDER THE DATA TABLE ----
  
  
# ENABLE DATA TO BE DOWNLOADED ----

  
} # END OF SERVER
```

# PHS Shiny dashboard

## Introduction tab: UI

```{r, eval = FALSE}
 navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            tabPanel(title = "Information", 
                     icon = icon("info-circle"),
                      fluidRow(
                        column(6,
                             h2("Background Information")),
                      ),
                      fluidRow(
                        column(12,
                          h4(tags$b("Allergic Conditions")),
                          p("Allergic conditions arise from an abnormal reaction of the immune system to a 
                            typically harmless environmental trigger. Allergic conditions have a wide 
                            variety of impacts on health, ranging from those that generally cause only 
                            minor symptoms,such as hay fever or conjunctivitis, to those that may be 
                            chronic and disabling, such as asthma, eczema or urticaria (hives)."), 
                          p("Some allergic conditions may be severe and life-threatening, such as 
                            anaphylaxis, although this is uncommon. Most allergic conditions are 
                            treated in primary care; only a minority of people require hospital referral."),
                          h4(tags$b("Asthma")),
                          p("Asthma is a chronic disease of the small airways in the lung. 
                            Airway inflammation and associated bronchoconstriction leads to recurrent attacks 
                            of cough, wheezing, breathlessness or chest tightness. The severity and frequency 
                            of these episodes varies from occasional slight wheezing to severe or sometimes, 
                            although rarely, life-threatening attacks."),
                          p("The underlying causes of asthma are not fully understood, but attacks are 
                            likely caused by an interaction between a susceptible host and 
                            environmental triggers. 
                            Environmental triggers may include viral upper respiratory tract infections, 
                            common allergens such as pollen, dust mites and pet dander, or more general 
                            exposures such as cold air or physical exercise. Asthma is more common in 
                            those with a family history of asthma or eczema and is also more common among 
                            children whose parents smoke. It also often co-exists with hay fever.")))
                      ),

# ALLERGIC CONDITIONS TAB ----
             

# ASTHMA TAB ----


# DATA DOWNLOADS TAB ----
             

 )
```

## Action button: UI

```{r, eval = FALSE}
navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            tabPanel(title = "Information", 
                     icon = icon("info-circle"),
                      fluidRow(
                        column(6,
                             h2("Background Information")),
                        column(6, actionButton("new_next", tags$b("New content and future updates"),
                                               icon = icon('calendar-alt')))
                      ), # end fluidRow
                      fluidRow(
                        column(12,
                          h4(tags$b("Allergic Conditions")),
                          p("Allergic conditions arise from an abnormal reaction of the immune system to a 
                            typically harmless environmental trigger. Allergic conditions have a wide 
                            variety of impacts on health, ranging from those that generally cause only 
                            minor symptoms,such as hay fever or conjunctivitis, to those that may be 
                            chronic and disabling, such as asthma, eczema or urticaria (hives)."), 
                          p("Some allergic conditions may be severe and life-threatening, such as 
                            anaphylaxis, although this is uncommon. Most allergic conditions are 
                            treated in primary care; only a minority of people require hospital referral."),
                          h4(tags$b("Asthma")),
                          p("Asthma is a chronic disease of the small airways in the lung. 
                            Airway inflammation and associated bronchoconstriction leads to recurrent attacks 
                            of cough, wheezing, breathlessness or chest tightness. The severity and frequency 
                            of these episodes varies from occasional slight wheezing to severe or sometimes, 
                            although rarely, life-threatening attacks."),
                          p("The underlying causes of asthma are not fully understood, but attacks are 
                            likely caused by an interaction between a susceptible host and 
                            environmental triggers. 
                            Environmental triggers may include viral upper respiratory tract infections, 
                            common allergens such as pollen, dust mites and pet dander, or more general 
                            exposures such as cold air or physical exercise. Asthma is more common in 
                            those with a family history of asthma or eczema and is also more common among 
                            children whose parents smoke. It also often co-exists with hay fever."))
                        ) # end fluidRow
                      ), # end tabPanel

# ALLERGIC CONDITIONS TAB ----
             

# ASTHMA TAB ----


# DATA DOWNLOADS TAB ----
             

 ) # end navbar
```

## Action button: Server

```{r, eval = FALSE}

function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  #output$chart <- renderPlotly({ 
  #  
  #  #Data for condition
  #  data_condition <- data_allergy %>% subset(type %in% input$conditions & measure==input$measure)
  #  
  #  #y axis title
  #  yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
  #                          input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
  #  
  #  plot <- 
  #    ggplot(data_condition, aes(x = year, y = value, colour = type)) +
  #    geom_line(aes(group=1)) +
  #    theme_minimal()
  #  
  #  ggplotly(height = 500,
  #           width = 1000) %>%
  #    layout(annotations = list(), #It needs this because of a buggy behaviour
  #           yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
  #           xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
  #           font = list(family = 'Arial, sans-serif'), # font
  #           margin = list(pad = 4, t = 50, r = 30), # margin-paddings
  #           hovermode = 'false') %>% # to get hover compare mode as default
  #    config(displayModeBar= T, displaylogo = F)
  #  #Layout
  #  # taking out plotly logo and collaborate button
  #}
  #)

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  #plot_charts <- function(sex_chosen, age_grp_chosen) { 
  #  
  #  data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
  #                                        sex == sex_chosen &
  #                                        age_grp == age_grp_chosen)
  #  
  #  #y axis title
  #  yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
  #                          input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
  #  
  #  plot <- 
  #    ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
  #    geom_line(aes(group=1)) +
  #    theme_minimal()
  #  
  #  ggplotly() %>%
  #    layout(annotations = list(),
  #           yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
  #           xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
  #           font = list(family = 'Arial, sans-serif'), 
  #           margin = list(pad = 4, t = 50, r = 30), 
  #           hovermode = 'false') %>% 
  #    config(displayModeBar= T, displaylogo = F) 
  #  
  #}
  #
  ## Here, the plot_charts function created above is put into use
  #output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% layout(title = "Males All Ages")}) 
  #output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% layout(title = "Females All Ages")}) 
  #output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% layout(title = "Males Under 10")})
  #output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% layout(title = "Females Under 10")}) 
  #output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% layout(title = "Males Over 10")}) 
  #output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% layout(title = "Females Over 10")})
  


# CREATE THE DATA TABLE ----


# RENDER THE DATA TABLE ----
  
  
# ENABLE DATA TO BE DOWNLOADED ----

  
} # END OF SERVER

```

## Allergic conditions: UI

```{r, eval = FALSE}
 navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            tabPanel(title = "Information", 
                     icon = icon("info-circle"),
                      fluidRow(
                        column(6,
                             h2("Background Information")),
                        column(6, actionButton("new_next", tags$b("New content and future updates"),
                                               icon = icon('calendar-alt')))
                      ),
                      fluidRow(
                        column(12,
                          h4(tags$b("Allergic Conditions")),
                          p("Allergic conditions arise from an abnormal reaction of the immune system to a 
                            typically harmless environmental trigger. Allergic conditions have a wide variety 
                            of impacts on health, ranging from those that generally cause only minor symptoms, 
                           such as hay fever or conjunctivitis, to those that may be chronic and disabling, 
                           such as asthma, eczema or urticaria (hives)."), 
                          p("Some allergic conditions may be severe and life-threatening, such as anaphylaxis, 
                             although this is uncommon. Most allergic conditions are treated in primary care; 
                             only a minority of people require hospital referral."),
                          h4(tags$b("Asthma")),
                          p("Asthma is a chronic disease of the small airways in the lung. Airway inflammation and 
                            associated bronchoconstriction leads to recurrent attacks of cough, wheezing, 
                            breathlessness or chest tightness. The severity and frequency of these episodes
                            varies from occasional slight wheezing to severe or sometimes, although rarely, 
                            life-threatening attacks."),
                          p("The underlying causes of asthma are not fully understood, but attacks are likely caused 
                            by an interaction between a susceptible host and environmental triggers. 
                            Environmental triggers may include viral upper respiratory tract infections, 
                            common allergens such as pollen, dust mites and pet dander, or more general exposures 
                            such as cold air or physical exercise. Asthma is more common in those with a family 
                            history of asthma or eczema and is also more common among children whose parents smoke. 
                            It also often co-exists with hay fever.")))
                      ),

# ALLERGIC CONDITIONS TAB ----
             tabPanel(title = "All Allergic Conditions", icon = icon("hospital"),
                      h2("Hospital admissions for different allergic conditions"),
                      p("Since most people with allergic conditions are managed in primary care,
                        secondary care (hospital) data relate to a smaller group of people, 
                        generally with more severe conditions."),
                      p("The chart shows data from the Scottish Morbidity Record (SMR01) scheme, which records 
                        hospital inpatient and day case activity for Scotland."), 
                      p("The chart shows that rates of hospital admissions per 100,000 of the population have 
                        remained relatively constant for all allergies across the past 10 years in Scotland."),
                      fluidRow(
                        column(3,
                               selectInput(inputId = "measure", 
                                           label = "Select numbers or rates",
                                           choices = c("Number", "Rate"), selected = "Rate")
                        ),
                        column(3,
                               selectizeInput(inputId = "conditions", 
                                              label = "Select one or more allergic conditions (up to four)", 
                                              choices = condition_list, multiple = TRUE, selected = "All allergies",
                                              options = list(maxItems =4L))
                        )
                      ), # end fluidRow
                      fluidRow(
                        column(3,
                               plotlyOutput("chart", width = "100%", height = "350px"))
                      ) # end fluidRow
                      ) # end tabPanel

# ASTHMA TAB ----


# DATA DOWNLOADS TAB ----
             

 ) # end navbar
```

## Allergic conditions: Server

```{r, eval=FALSE}
function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  output$chart <- renderPlotly({ 
    
    #Data for condition
    data_condition <- data_allergy %>% 
      subset(type %in% input$conditions & measure==input$measure)
    
    #y axis title
    yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
                            input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_condition, aes(x = year, y = value, colour = type)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly(height = 500,
             width = 1000) %>%
      layout(annotations = list(), #It needs this because of a buggy behaviour
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), # font
             margin = list(pad = 4, t = 50, r = 30), # margin-paddings
             hovermode = 'false') %>% # to get hover compare mode as default
      config(displayModeBar= T, displaylogo = F) # taking out plotly logo and collaborate button
  }
  )

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  #plot_charts <- function(sex_chosen, age_grp_chosen) { 
  #  
  #  data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
  #                                        sex == sex_chosen &
  #                                        age_grp == age_grp_chosen)
  #  
  #  #y axis title
  #  yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
  #                          input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
  #  
  #  plot <- 
  #    ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
  #    geom_line(aes(group=1)) +
  #    theme_minimal()
  #  
  #  ggplotly() %>%
  #    layout(annotations = list(),
  #           yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
  #           xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
  #           font = list(family = 'Arial, sans-serif'), 
  #           margin = list(pad = 4, t = 50, r = 30), 
  #           hovermode = 'false') %>% 
  #    config(displayModeBar= T, displaylogo = F) 
  #  
  #}
  #
  ## Here, the plot_charts function created above is put into use
  #output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% layout(title = "Males All Ages")}) 
  #output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% layout(title = "Females All Ages")}) 
  #output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% layout(title = "Males Under 10")})
  #output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% layout(title = "Females Under 10")}) 
  #output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% layout(title = "Males Over 10")}) 
  #output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% layout(title = "Females Over 10")})
  


# CREATE THE DATA TABLE ----


# RENDER THE DATA TABLE ----
  
  
# ENABLE DATA TO BE DOWNLOADED ----

  
} # END OF SERVER
```

## Asthma: UI

```{r, eval=FALSE}
 navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            tabPanel(title = "Information", 
                     icon = icon("info-circle"),
                      fluidRow(
                        column(6,
                             h2("Background Information")),
                        column(6, actionButton("new_next", tags$b("New content and future updates"),
                                               icon = icon('calendar-alt')))
                      ),
                      fluidRow(
                        column(12,
                          h4(tags$b("Allergic Conditions")),
                          p("Allergic conditions arise from an abnormal reaction of the immune system to a 
                            typically harmless environmental trigger. Allergic conditions have a wide variety 
                            of impacts on health, ranging from those that generally cause only minor symptoms, 
                           such as hay fever or conjunctivitis, to those that may be chronic and disabling, 
                           such as asthma, eczema or urticaria (hives)."), 
                          p("Some allergic conditions may be severe and life-threatening, 
                            such as anaphylaxis, although this is uncommon. Most allergic conditions are 
                            treated in primary care; only a minority of people require hospital referral."),
                          h4(tags$b("Asthma")),
                          p("Asthma is a chronic disease of the small airways in the lung.
                            Airway inflammation and associated bronchoconstriction leads to recurrent attacks of 
                            cough, wheezing, breathlessness or chest tightness. The severity and frequency of 
                            these episodes varies from occasional slight wheezing to severe or sometimes, 
                            although rarely, life-threatening attacks."),
                          p("The underlying causes of asthma are not fully understood, but attacks are 
                            likely caused by an interaction between a susceptible host and 
                            environmental triggers. 
                            Environmental triggers may include viral upper respiratory tract infections, 
                            common allergens such as pollen, dust mites and pet dander, or more general exposures 
                            such as cold air or physical exercise. Asthma is more common in those with a family 
                            history of asthma or eczema and is also more common among children whose parents smoke. 
                            It also often co-exists with hay fever."))) # end fluidRow
                      ), # end tabPanel

# ALLERGIC CONDITIONS TAB ----
             tabPanel(title = "All Allergic Conditions", 
                      icon = icon("hospital"),
                      h2("Hospital admissions for different allergic conditions"),
                      p("Since most people with allergic conditions are managed in primary care,
                        secondary care (hospital) data relate to a smaller group of people, 
                        generally with more severe conditions."),
                      p("The chart shows data from the Scottish Morbidity Record (SMR01) scheme, 
                        which records hospital inpatient and day case activity for Scotland."), 
                      p("The chart shows that rates of hospital admissions per 100,000 
                        of the population have remained relatively constant for all allergies 
                        across the past 10 years in Scotland."),
                      fluidRow(
                        column(3,
                               selectInput(inputId = "measure", 
                                           label = "Select numbers or rates",
                                           choices = c("Number", "Rate"), 
                                           selected = "Rate")
                        ),
                        column(3,
                               selectizeInput(inputId = "conditions", 
                                              label = "Select one or more allergic conditions (up to four)", 
                                              choices = condition_list, multiple = TRUE, 
                                              selected = "All allergies",
                                              options = list(maxItems =4L))
                        )
                      ), # end fluidRow
                      fluidRow(
                        column(3,
                               plotlyOutput("chart", width = "100%", height = "350px"))
                        ) # end fluidRow
                      ), # end tabPanel

# ASTHMA TAB ----
              tabPanel(title = "Asthma Breakdown", 
                       icon = icon("area-chart"),
                       h2("Asthma Exploration Work"),
                       p("The selection of charts below show how hospital admissions for asthma related 
                         diagnosis codes have changed over the past 10 years across different age groups."),
                       p("The data is split by sex (all males and all females) and by the following age groups: 
                         under 10 years old and over 10 years old."),
                       
                       fluidRow(
                         column(3,
                                selectInput(inputId = "measure_asthma", 
                                            label = "Select numerator or rates",
                                            choices = c("Numerator", "Rate"), 
                                            selected = "Rate")),
                         column(3,
                                selectizeInput(inputId = "diagnosis", 
                                               label = "Select one or more diagnosis", 
                                               choices = diagnosis_list, multiple = TRUE, 
                                               selected = "Status asthmaticus (J46) first position"),
                                options = list(maxItems =4L))
                       ), # end fluidRow
                       
                       fluidRow(
                         column(6,
                                plotlyOutput("male_all", width = "100%")),
                         column(6,
                                plotlyOutput("female_all", width = "100%")),
                         column(6,
                                plotlyOutput("male_under10", width = "100%")),
                         column(6,
                                plotlyOutput("female_under10", width = "100%")),
                         column(6,
                                plotlyOutput("male_over10", width = "100%")),
                         column(6,
                                plotlyOutput("female_over10", width = "100%"))
                       ) # end fluidRow
              ) # end tabPanel

# DATA DOWNLOADS TAB ----
             

 ) # end navbar
```

## Asthma: Server

```{r, eval=FALSE}
function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  output$chart <- renderPlotly({ 
    
    #Data for condition
    data_condition <- data_allergy %>% 
      subset(type %in% input$conditions & measure==input$measure)
    
    #y axis title
    yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
                            input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_condition, aes(x = year, y = value, colour = type)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly(height = 500,
             width = 1000) %>%
      layout(annotations = list(), #It needs this because of a buggy behaviour
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), # font
             margin = list(pad = 4, t = 50, r = 30), # margin-paddings
             hovermode = 'false') %>% # to get hover compare mode as default
      config(displayModeBar= T, displaylogo = F) # taking out plotly logo and collaborate button
  }
  )

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  plot_charts <- function(sex_chosen, age_grp_chosen) { 
    
    data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
                                          sex == sex_chosen &
                                          age_grp == age_grp_chosen)
    
    #y axis title
    yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
                            input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly() %>%
      layout(annotations = list(),
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), 
             margin = list(pad = 4, t = 50, r = 30), 
             hovermode = 'false') %>% 
      config(displayModeBar= T, displaylogo = F) 
    
  }
  
  # Here, the plot_charts function created above is put into use
  output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% 
      layout(title = "Males All Ages")}) 
  output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% 
      layout(title = "Females All Ages")}) 
  output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% 
      layout(title = "Males Under 10")})
  output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% 
      layout(title = "Females Under 10")}) 
  output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% 
      layout(title = "Males Over 10")}) 
  output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% 
      layout(title = "Females Over 10")})
  


# CREATE THE DATA TABLE ----


# RENDER THE DATA TABLE ----
  
  
# ENABLE DATA TO BE DOWNLOADED ----

  
}
```

## Data downloads: UI

```{r, eval=FALSE}
 navbarPage(title = div(tags$a(img(src="phs-logo.png", width=120, alt = "Public Health Scotland logo"), #bringing in PHS logo and look for dashboard
                               href= "https://www.publichealthscotland.scot/",
                               target = "_blank"),
                        style = "position: relative; top: -10px;"), 
            header = tags$head(includeCSS("www/styles.css"), # CSS styles
                               HTML("<html lang='en'>"),
                               tags$link(rel="shortcut icon", href="favicon_phs.ico")), 

# INFORMATION TAB ----
            tabPanel(title = "Information", 
                     icon = icon("info-circle"),
                      fluidRow(
                        column(6,
                             h2("Background Information")),
                        column(6, actionButton("new_next", tags$b("New content and future updates"),
                                               icon = icon('calendar-alt')))
                      ),
                      fluidRow(
                        column(12,
                          h4(tags$b("Allergic Conditions")),
                          p("Allergic conditions arise from an abnormal reaction of the immune system to a 
                            typically harmless environmental trigger. Allergic conditions have a wide variety 
                            of impacts on health, ranging from those that generally cause only minor symptoms, 
                           such as hay fever or conjunctivitis, to those that may be chronic and disabling, 
                           such as asthma, eczema or urticaria (hives)."), 
                          p("Some allergic conditions may be severe and life-threatening, such as anaphylaxis, 
                             although this is uncommon. Most allergic conditions are treated in primary care; 
                             only a minority of people require hospital referral."),
                          h4(tags$b("Asthma")),
                          p("Asthma is a chronic disease of the small airways in the lung. 
                            Airway inflammation and associated bronchoconstriction leads to 
                            recurrent attacks of cough, wheezing, breathlessness or chest tightness. 
                            The severity and frequency of these episodes varies from occasional slight 
                            wheezing to severe or sometimes, although rarely, life-threatening attacks."),
                          p("The underlying causes of asthma are not fully understood, but attacks 
                            are likely caused by an interaction between a susceptible host and 
                            environmental triggers. 
                            Environmental triggers may include viral upper respiratory tract infections, 
                            common allergens such as pollen, dust mites and pet dander, or more general exposures 
                            such as cold air or physical exercise. Asthma is more common in those with a family 
                            history of asthma or eczema and is also more common among children whose parents smoke. 
                            It also often co-exists with hay fever."))) # end fluidRow
                      ), # end tabPanel

# ALLERGIC CONDITIONS TAB ----
             tabPanel(title = "All Allergic Conditions", icon = icon("hospital"),
                      h2("Hospital admissions for different allergic conditions"),
                      p("Since most people with allergic conditions are managed in primary care,
                        secondary care (hospital) data relate to a smaller group of people, 
                        generally with more severe conditions."),
                      p("The chart shows data from the Scottish Morbidity Record (SMR01) scheme, which records 
                        hospital inpatient and day case activity for Scotland."), 
                      p("The chart shows that rates of hospital admissions per 100,000 of the population have 
                        remained relatively constant for all allergies across the past 10 years in Scotland."),
                      fluidRow(
                        column(3,
                               selectInput(inputId = "measure", 
                                           label = "Select numbers or rates",
                                           choices = c("Number", "Rate"), 
                                           selected = "Rate")
                        ),
                        column(3,
                               selectizeInput(inputId = "conditions", 
                                              label = "Select one or more allergic conditions (up to four)", 
                                              choices = condition_list, multiple = TRUE, 
                                              selected = "All allergies",
                                              options = list(maxItems =4L))
                        )
                      ), # end fluidRow
                      fluidRow(
                        column(3,
                               plotlyOutput("chart", width = "100%", height = "350px"))
                        ) # end fluidRow
                      ), # end tabPanel

# ASTHMA TAB ----
              tabPanel(title = "Asthma Breakdown", icon = icon("area-chart"),
                       h2("Asthma Exploration Work"),
                       p("The selection of charts below show how hospital admissions for asthma related 
                         diagnosis codes have changed over the past 10 years across different age groups."),
                       p("The data is split by sex (all males and all females) and by the following age groups: 
                         under 10 years old and over 10 years old."),
                       
                       fluidRow(
                         column(3,
                                selectInput(inputId = "measure_asthma", 
                                            label = "Select numerator or rates",
                                            choices = c("Numerator", "Rate"), 
                                            selected = "Rate")),
                         column(3,
                                selectizeInput(inputId = "diagnosis", 
                                               label = "Select one or more diagnosis", 
                                               choices = diagnosis_list, multiple = TRUE, 
                                               selected = "Status asthmaticus (J46) first position"),
                                options = list(maxItems =4L))
                       ), # end fluidRow
                       
                       fluidRow(
                         column(6,
                                plotlyOutput("male_all", width = "100%")),
                         column(6,
                                plotlyOutput("female_all", width = "100%")),
                         column(6,
                                plotlyOutput("male_under10", width = "100%")),
                         column(6,
                                plotlyOutput("female_under10", width = "100%")),
                         column(6,
                                plotlyOutput("male_over10", width = "100%")),
                         column(6,
                                plotlyOutput("female_over10", width = "100%"))
                       ) # end fluidRow
                       ), # end tabPanel

# DATA DOWNLOADS TAB ----

              tabPanel(title = "Data Table Downloads", icon = icon("table"),
                       h2("Select the data you wish to download"),
                       p("This section allows you to view the data in table format.
                                      You can use the filters to select the data you are interested in.
                                      You can also download the data as a csv using the download button."),
                       
                       fluidRow(
                         column(6, selectInput(inputId = "data_select", 
                                               label = "Select the data you want to explore.",
                                               choices = data_list_data_tab)),
                         column(6, downloadButton(outputId = 'download_table_csv', 
                                                  label = 'Download data')),
                         
                         DT::dataTableOutput("table_filtered")
                         ) # end fluidRow
                       ) # end tabPanel
) 
```

## Data downloads: Server data reactive

```{r, eval = FALSE}
function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  output$chart <- renderPlotly({ 
    
    #Data for condition
    data_condition <- data_allergy %>% 
      subset(type %in% input$conditions & measure==input$measure)
    
    #y axis title
    yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
                            input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_condition, aes(x = year, y = value, colour = type)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly(height = 500,
             width = 1000) %>%
      layout(annotations = list(), #It needs this because of a buggy behaviour
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), # font
             margin = list(pad = 4, t = 50, r = 30), # margin-paddings
             hovermode = 'false') %>% # to get hover compare mode as default
      config(displayModeBar= T, displaylogo = F) # taking out plotly logo and collaborate button
  }
  )

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  plot_charts <- function(sex_chosen, age_grp_chosen) { 
    
    data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
                                          sex == sex_chosen &
                                          age_grp == age_grp_chosen)
    
    #y axis title
    yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
                            input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly() %>%
      layout(annotations = list(),
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), 
             margin = list(pad = 4, t = 50, r = 30), 
             hovermode = 'false') %>% 
      config(displayModeBar= T, displaylogo = F) 
    
  }
  
  # Here, the plot_charts function created above is put into use
  output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% 
      layout(title = "Males All Ages")}) 
  output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% 
      layout(title = "Females All Ages")}) 
  output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% 
      layout(title = "Males Under 10")})
  output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% 
      layout(title = "Females Under 10")}) 
  output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% 
      layout(title = "Males Over 10")}) 
  output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% 
      layout(title = "Females Over 10")})

# CREATE THE DATA TABLE ----
  
  data_table <- reactive({
    # Change dataset depending on what user selected
    table_data <- switch(input$data_select,
                         "data_allergy" = data_allergy, 
                         "data_asthma" = data_asthma)
    
    if (input$data_select == "data_allergy") { 
      table_data %<>%
        select(year, type, measure, value)
    } else if (input$data_select == "data_asthma") { 
      table_data %<>%
        select(diagnosis, year, sex, age_grp, numerator, rate)
    }
  })
  
  # RENDER THE DATA TABLE ----
  
  
# ENABLE DATA TO BE DOWNLOADED ----

  
}
```

## Data downloads: Server render table 
```{r, eval = FALSE}
function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  output$chart <- renderPlotly({ 
    
    #Data for condition
    data_condition <- data_allergy %>% 
      subset(type %in% input$conditions & measure==input$measure)
    
    #y axis title
    yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
                            input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_condition, aes(x = year, y = value, colour = type)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly(height = 500,
             width = 1000) %>%
      layout(annotations = list(), #It needs this because of a buggy behaviour
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), # font
             margin = list(pad = 4, t = 50, r = 30), # margin-paddings
             hovermode = 'false') %>% # to get hover compare mode as default
      config(displayModeBar= T, displaylogo = F) # taking out plotly logo and collaborate button
  }
  )

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  plot_charts <- function(sex_chosen, age_grp_chosen) { 
    
    data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
                                          sex == sex_chosen &
                                          age_grp == age_grp_chosen)
    
    #y axis title
    yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
                            input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly() %>%
      layout(annotations = list(),
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), 
             margin = list(pad = 4, t = 50, r = 30), 
             hovermode = 'false') %>% 
      config(displayModeBar= T, displaylogo = F) 
    
  }
  
  # Here, the plot_charts function created above is put into use
  output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% 
      layout(title = "Males All Ages")}) 
  output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% 
      layout(title = "Females All Ages")}) 
  output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% 
      layout(title = "Males Under 10")})
  output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% 
      layout(title = "Females Under 10")}) 
  output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% 
      layout(title = "Males Over 10")}) 
  output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% 
      layout(title = "Females Over 10")})

# CREATE THE DATA TABLE ----
  
  data_table <- reactive({
    # Change dataset depending on what user selected
    table_data <- switch(input$data_select,
                         "data_allergy" = data_allergy, 
                         "data_asthma" = data_asthma)
    
    if (input$data_select == "data_allergy") { 
      table_data %<>%
        select(year, type, measure, value)
    } else if (input$data_select == "data_asthma") { 
      table_data %<>%
        select(diagnosis, year, sex, age_grp, numerator, rate)
    }
  })

# RENDER THE DATA TABLE ----
  
  output$table_filtered <- DT::renderDataTable({
    
    # Remove the underscore from column names in the table
    table_colnames  <-  gsub("_", " ", colnames(data_table()))
    
    DT::datatable(data_table(), 
                  style = 'bootstrap',
                  class = 'table-bordered table-condensed',
                  rownames = FALSE,
                  options = list(pageLength = 20,
                                 dom = 'tip',
                                 autoWidth = TRUE),
                  filter = "top",
                  colnames = table_colnames)
  })
  
# ENABLE DATA TO BE DOWNLOADED ----

  
} # END OF SERVER
```

## Data downloads: Sever downloads button
```{r, eval = FALSE}

function(input, output) {
  
# NEW CONTENT AND FUTURE UPDATES INFO BUTTON ----
  
  observeEvent(input$new_next,
               showModal(modalDialog( # creats a modal: a pop-up box that contains text information
                 title = "New content added and future updates",
                 h4("Future updates"),
                 tags$ul(
                   tags$li("7 July 2023 - Allergies data update."),
                   tags$li("16 June 2025 - Asthma data update.")),
                 size = "m",
                 easyClose = TRUE, fade=FALSE,footer = modalButton("Close (Esc)")))) # creates the esc button for closing the popup box

  
# CREATE ALLERGIES CHART - PLOTLY CODE ----

  output$chart <- renderPlotly({ 
    
    #Data for condition
    data_condition <- data_allergy %>% 
      subset(type %in% input$conditions & measure==input$measure)
    
    #y axis title
    yaxistitle <- case_when(input$measure == "Number" ~ "Number of hospital admissions",
                            input$measure == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_condition, aes(x = year, y = value, colour = type)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly(height = 500,
             width = 1000) %>%
      layout(annotations = list(), #It needs this because of a buggy behaviour
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), # font
             margin = list(pad = 4, t = 50, r = 30), # margin-paddings
             hovermode = 'false') %>% # to get hover compare mode as default
      config(displayModeBar= T, displaylogo = F) # taking out plotly logo and collaborate button
  }
  )

# CREATE ASTHMA CHARTS - PLOTLY CODE ----


  plot_charts <- function(sex_chosen, age_grp_chosen) { 
    
    data_plot <- data_asthma %>% subset(diagnosis %in% input$diagnosis & 
                                          sex == sex_chosen &
                                          age_grp == age_grp_chosen)
    
    #y axis title
    yaxistitle <- case_when(input$measure_asthma == "Numerator" ~ "Number of hospital admissions",
                            input$measure_asthma == "Rate" ~ "Hospital admissions <br>per 100,000 population")
    
    plot <- 
      ggplot(data_plot, aes(x = year, y = get(tolower(input$measure_asthma)), colour = diagnosis)) +
      geom_line(aes(group=1)) +
      theme_minimal()
    
    ggplotly() %>%
      layout(annotations = list(),
             yaxis = list(title = yaxistitle, rangemode="tozero", fixedrange=TRUE), 
             xaxis = list(title = "Financial year",  fixedrange=TRUE, tickangle = 270),  
             font = list(family = 'Arial, sans-serif'), 
             margin = list(pad = 4, t = 50, r = 30), 
             hovermode = 'false') %>% 
      config(displayModeBar= T, displaylogo = F) 
    
  }
  
  # Here, the plot_charts function created above is put into use
  output$male_all <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "All") %>% 
      layout(title = "Males All Ages")}) 
  output$female_all <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "All") %>% 
      layout(title = "Females All Ages")}) 
  output$male_under10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Under 10") %>% 
      layout(title = "Males Under 10")})
  output$female_under10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Under 10") %>% 
      layout(title = "Females Under 10")}) 
  output$male_over10 <- renderPlotly({ plot_charts(sex_chosen = "Male", age_grp_chosen = "Over 10") %>% 
      layout(title = "Males Over 10")}) 
  output$female_over10 <- renderPlotly({ plot_charts(sex_chosen = "Female", age_grp_chosen = "Over 10") %>% 
      layout(title = "Females Over 10")})

# CREATE THE DATA TABLE ----
  
  data_table <- reactive({
    # Change dataset depending on what user selected
    table_data <- switch(input$data_select,
                         "data_allergy" = data_allergy, 
                         "data_asthma" = data_asthma)
    
    if (input$data_select == "data_allergy") { 
      table_data %<>%
        select(year, type, measure, value)
    } else if (input$data_select == "data_asthma") { 
      table_data %<>%
        select(diagnosis, year, sex, age_grp, numerator, rate)
    }
  })

# RENDER THE DATA TABLE ----
  
  output$table_filtered <- DT::renderDataTable({
    
    # Remove the underscore from column names in the table
    table_colnames  <-  gsub("_", " ", colnames(data_table()))
    
    DT::datatable(data_table(), 
                  style = 'bootstrap',
                  class = 'table-bordered table-condensed',
                  rownames = FALSE,
                  options = list(pageLength = 20,
                                 dom = 'tip',
                                 autoWidth = TRUE),
                  filter = "top",
                  colnames = table_colnames)
  })
  
# ENABLE DATA TO BE DOWNLOADED ----
  output$download_table_csv <- downloadHandler(
    filename = function() {
      paste(input$data_select, ".csv", sep = "")
    },
    content = function(file) {
      # This downloads only the data the user has selected using the table filters
      write_csv(data_table()[input[["table_filtered_rows_all"]], ], file) 
    } 
  )
  
} # END OF SERVER
```

